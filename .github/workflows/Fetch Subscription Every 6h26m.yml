name: Fetch Subscription Every 6h26m

on:
  schedule:
    - cron: "26 */6 * * *"  # 每 6 小時 26 分鐘執行一次（UTC時間）
  workflow_dispatch:

jobs:
  fetch_subscription:
    runs-on: ubuntu-latest
    env:
      NHOST_GRAPHQL_URL: ${{ secrets.NHOST_GRAPHQL_URL }}
      NHOST_ADMIN_SECRET: ${{ secrets.NHOST_ADMIN_SECRET }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch subscription from Nhost GraphQL
        run: |
          set -x
          curl -s -X POST "$NHOST_GRAPHQL_URL" \
            -H "Content-Type: application/json" \
            -H "x-hasura-admin-secret: $NHOST_ADMIN_SECRET" \
            -d '{
              "query": "query { subscription(order_by: { nextdate: asc }) { id name site price nextdate note account } }"
            }' \
            -o subscription.json

      - name: Show fetched data
        run: cat subscription.json

      - name: Commit & push JSON if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add subscription.json
          git diff --cached --quiet || git commit -m "Update subscription JSON"
          git push
